package middleware

import (
	"context"

	"github.com/labstack/echo/v4"
)

const (
	sessionIDKey    contextKey = "sessionID"
	SessionIDHeader string     = "X-Session-Id" // HTTP header name
)

// SessionIDMiddleware extracts the X-Session-Id header from requests and stores it in context.
// Unlike RequestIDMiddleware, this does NOT generate an ID if missing - session IDs are only
// generated by the SSE handler on client connect. Missing session ID means the request
// is from a client that hasn't connected to SSE (e.g., curl testing).
func SessionIDMiddleware(next echo.HandlerFunc) echo.HandlerFunc {
	return func(c echo.Context) error {
		req := c.Request()
		sid := req.Header.Get(SessionIDHeader)
		if sid != "" {
			// Store in context for downstream handlers/services
			ctx := context.WithValue(req.Context(), sessionIDKey, sid)
			c.SetRequest(req.WithContext(ctx))
		}
		return next(c)
	}
}

// GetSessionID extracts the session ID from context, or returns empty string if not found.
func GetSessionID(ctx context.Context) string {
	if v := ctx.Value(sessionIDKey); v != nil {
		if sid, ok := v.(string); ok {
			return sid
		}
	}
	return ""
}
