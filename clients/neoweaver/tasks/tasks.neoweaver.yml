version: '3'

vars:
  PROTO_DIR: ../../proto/mind/v3
  TS_GEN_DIR: gen/ts
  TYPES_OUTPUT: lua/neoweaver/types.lua
  SCRIPTS_DIR: scripts

tasks:
  types:proto:
    desc: Generate TypeScript types from proto files
    dir: '{{.PROTO_DIR}}'
    cmds:
      - buf generate
    sources:
      - '*.proto'
    generates:
      - ../../../clients/neoweaver/gen/ts/v3/*_pb.ts

  types:ts-to-lua:
    desc: Convert TypeScript types to Lua annotations
    deps:
      - types:proto
    cmds:
      - '{{.SCRIPTS_DIR}}/ts-to-lua.sh {{.TS_GEN_DIR}} {{.TYPES_OUTPUT}}'
    sources:
      - '{{.TS_GEN_DIR}}/v3/*_pb.ts'
    generates:
      - '{{.TYPES_OUTPUT}}'

  types:cleanup:
    desc: Remove temporary TypeScript files
    deps:
      - types:ts-to-lua
    cmds:
      - rm -rf {{.TS_GEN_DIR}}

  types:generate:
    desc: Generate Lua type annotations from protobuf definitions (full pipeline)
    aliases: [types:gen]
    deps:
      - types:proto
      - types:ts-to-lua
      - types:cleanup

  types:clean:
    desc: Remove all generated files (Lua types and TypeScript)
    cmds:
      - rm -f {{.TYPES_OUTPUT}}
      - rm -rf {{.TS_GEN_DIR}}

  docs:api:
    desc: Generate API documentation from LuaLS annotations using mini.doc
    cmds:
      - nvim -u scripts/make_api_documentation/minimal_init.lua -l scripts/make_api_documentation/main.lua
    sources:
      - lua/neoweaver/init.lua
      - lua/neoweaver/types.lua
    generates:
      - doc/neoweaver_api.txt
      - doc/neoweaver_types.txt

  docs:tags:
    desc: Generate vim help tags
    deps: [docs:api]
    cmds:
      - nvim -c 'helptags doc' -c 'quit'
    sources:
      - doc/*.txt
    generates:
      - doc/tags

  docs:generate:
    desc: Generate all documentation (API docs + vim tags)
    aliases: [docs:gen, docs]
    deps: [docs:api, docs:tags]

  docs:clean:
    desc: Remove generated documentation files
    cmds:
      - rm -f doc/neoweaver_api.txt doc/neoweaver_types.txt doc/tags
